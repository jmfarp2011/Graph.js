/*! graph 15-01-2015 */
var Graph={version:"0.0.2"};Graph.Edge=function(a){this.entity=a.entity,this.rel=a.rel,this.type=a.type},Graph.Collection=function(a,b){var c={},d=[],e=a instanceof Graph.Database?a:a.db();Object.defineProperty(this,"length",{get:function(){return d.length}}),Object.defineProperty(this,"data",{get:function(){return d.slice()}});var f=function(a){return a.cid=a.id||a.cid||e.indexGenerator(a),a.cid},g={is:function(a,b){return a===b},gt:function(a,b){return a>b},lt:function(a,b){return b>a},gte:function(a,b){return a>=b},lte:function(a,b){return b>=a},regex:function(a,b){return a.search(b)>=0}},h=function(a){return a in c};this.add=function(a,b){if(f(a),!h(a.cid))return c[f(a)]=d.length,d.push(a),a;if(b){var e=d[c[a.cid]];return e.edit(a instanceof Graph.Entity?a.entity():a),e}return!1},this.remove=function(a){return h(a)?(d.splice(c[a],1),delete c[a],!0):!1},this.spawn=function(){return new Graph.Collection(a,d.slice())};var i=function(a,b){return b.length>1?i(a[b[0]],b.slice(1)):a[b[0]]};this.filter=function(b,c){c=!!c;for(var e,f=Object.keys(b),h=d.slice(),j=[],k=0,l=f.length;l>k;k++){e=f[k].split("__"),e.length<2&&e.push("is");var m=e.pop();j.push({key:e,op:m,value:b[f[k]]})}for(l=j.length,k=0;l>k;k++)for(var n=0;n<h.length;n++)e=j[k],i(h[n],e.key)&&g[e.op](i(h[n],e.key),e.value)===c&&h.splice(n--,1);return new Graph.Collection(a,h)},this.sort=function(a,b){function c(a,c){var d=b?-1:1,f=i(a,e),g=i(c,e);return g>f?-1*d:f>g?1*d:0}var e=a.split("__");return d.sort(c),this};var j=-1;if(this.first=function(){return j=-1,d[++j]},this.next=function(){if(!this.hasNext())throw new Error("Read past end of Collection.");return d[++j]},this.last=function(){return j=d.length,d[--j]},this.hasNext=function(){return j<d.length-1},b)for(var k=0,l=b.length;l>k;k++)this.add(b[k])},Graph.Entity=function(a,b){if(!(b instanceof Graph.Database))throw new Error("Must supply valid instance of Graph.Database");var c={};for(var d in a)a.hasOwnProperty(d)&&"function"!=typeof a[d]&&(this[d]=a[d]);this.db=function(){return b},this.on=function(a,b){c[a]=b},this.off=function(a){delete c[a]};var e=new Graph.Collection(this);this.entity=function(){var a={};for(var b in this)this.hasOwnProperty(b)&&"function"!=typeof this[b]&&(a[b]=this[b]);return a},this.edit=function(a){var b=[];for(var d in a)a.hasOwnProperty(d)&&(b.push({property:d,newValue:a[d],oldValue:this[d]}),this[d]=a[d]);return c.change&&c.change.call(this,"change",b),this},this.save=function(){b.update(this.cid,this.entity())},this["delete"]=function(){b.remove(this.cid)},this.edges=function(){return e},this.link=function(a){var b=new Graph.Edge(a);e.add(b),c.addedge&&c.addedge.call(this,"addedge",{entity:this,edge:b})};var f=function(a,b){b=b||[],b.push(a.cid);for(var c=[],d=0,f=0,g=e.length;g>f;f++){var h=0===f?e.first():e.next();b.indexOf(h.entity.cid)<0&&(c.push({name:h.entity.name,rel:h.rel,type:h.type,cid:h.entity.cid,edges:[]}),c[d].edges=h.entity.graph({method:"DFS",read:b}),d++)}return c},g=function(a){function b(a){for(var b=0,c=d.length;c>b;b++)if(d[b].entity===a)return!0;return!1}for(var c=[],d=[{entity:a,edges:c}],e=[];d.length>0;){var f=d.shift();e.push(f.entity);for(var g=0,h=f.entity.edges().length;h>g;g++){var i=0===g?f.entity.edges().first():f.entity.edges().next(),j=[];b(i.entity)||-1!==e.indexOf(i.entity)||(f.edges.push({name:i.entity.name,rel:i.rel,type:i.type,cid:i.entity.cid,edges:j}),d.push({entity:i.entity,edges:j}))}}return c};this.graph=function(a){var b=a.method,c=a.read;switch(b){case"DFS":return f(this,c);case"BFS":return g(this);default:throw new Error("Graph method "+b+" not supported.")}}},Graph.Database=function(a){var b=a&&a.datasource?a.datasource:{entities:[],edges:[]};this.indexGenerator=a?a.indexGenerator:void 0,this.index=function(a){if(!this.indexGenerator)throw new Error("No index generator method exists on database.");if("function"==typeof this.indexGenerator)return a.cid=this.indexGenerator(a),a.cid;if("string"==typeof this.indexGenerator)return a.cid=a[this.indexGenerator],a.cid;throw new Error("Unable to index the supplied Object.")};var c=new Graph.Collection(this);this.add=function(a){return c.add(new Graph.Entity(a,this))},this.query=function(){return c.spawn()},this.update=function(a,b){var d=c.filter({cid:a}).first();d.edit(b)},this.remove=function(a){c.remove(a)},this.link=function(a,b,d){var e=c.filter({cid:a}).first(),f=c.filter({cid:b}).first();e&&f&&(e.link({entity:f,rel:d,type:"out"}),f.link({entity:e,rel:d,type:"in"}))},this.ingest=function(a){for(var b=0;b<a.entities.length;b++)c.add(new Graph.Entity(a.entities[b],this));for(b=0;b<a.edges.length;b++)this.link(a.edges[b].source,a.edges[b].target,a.edges[b].rel)},this.ingest(b),this.on=function(a,b,d){if(d)c.filter({uid:d}).first().on(a,b);else for(var e=0,f=c.length;f>e;e++)e=c.next().on(a,b)},this.off=function(a,b){if(b)c.filter({uid:b}).first().off(a);else for(var d=0,e=c.length;e>d;d++)d=c.next().off(a)}},Graph.Dashboard=function(a){var b=this,c=a.container||null,d={};d["default"]={},d["default"].filterData={},d["default"].layout=a.layout||null;var e=a.database||null;c.addClass("graph_dashboard");var f=[],g={off:function(){}},h=[],i=function(a){for(var e=d[a].layout,f=0,g=e.rows.length;g>f;f++)for(var h=$('<div class="'+e.rows[f]["class"]+'" />').appendTo(c),i=0,j=e.rows[f].cols.length;j>i;i++)$('<div class="'+e.rows[f].cols[i]["class"]+'" id="'+e.rows[f].cols[i].component.name+'" />').appendTo(h),b.register(e.rows[f].cols[i].component)};this.addLayout=function(a,b,c){d[a]={filterData:b,layout:c}},this.bind=function(a){if(!a instanceof Graph.Entity)throw new TypeError("Graph.Dashboard can only be bound to objects of type Graph.Entity");for(var b=0,e=h.length;e>b;b++)g.off(h[b]),a.on(h[b],this.update);g=a,c.html(""),f=[];var j="default";for(var k in d){var l=!1,m=Object.keys(d[k].filterData);for(e=m.length,b=0;e>b;b++){if(d[k].filterData[m[b]]!==a[m[b]]){l=!1;break}l=!0}if(l){j=k;break}}for(i(j),b=0;b<f.length;b++)f[b].render&&$("#"+f[b].name).html(f[b].render(g))},this.bindFirst=function(a){this.bind(e.query().filter(a).first())},this.register=function(a){f.push(a);for(var b in a.events)-1===h.indexOf(b)&&h.push(b.replace(/^(on)/m,""));a.dashboard=this},this.update=function(a,b){for(var c=0;c<f.length;c++)f[c].events["on"+a]&&f[c].events["on"+a].call(f[c],b)},i("default")},Graph.Component={name:"base",render:function(a){var b=$('<div class="graph_component" id="graph_component_'+this.name+'"/>');for(var c in a.entity())a.hasOwnProperty(c)&&"function"!=typeof a[c]&&b.append(c+': <span class="graph_component_'+this.name+'" id="graph_component_'+this.name+"_"+c+'">'+a[c]+" </span><br/>");return b},events:{onchange:function(a){for(var b=0,c=a.length;c>b;b++)$("span#graph_component_"+this.name+"_"+a[b].property).text(a[b].newValue)}},extend:function(a){var b=Object.create(this);for(var c in this)b[c]=a[c]||this[c];for(c in a)b[c]||(b[c]=a[c]);return b}};