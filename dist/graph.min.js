/*! graph 23-04-2015 */
var Graph={version:"apricot"};Graph.Edge=function(a){this.entity=a.entity,this.rel=a.rel,this.type=a.type},Graph.Collection=function(a,b){var c={},d=[],e=a instanceof Graph.Database?a:a.db();Object.defineProperty(this,"length",{get:function(){return d.length}}),Object.defineProperty(this,"data",{get:function(){return d.slice()}});var f=function(a){if(a instanceof Graph.Entity)return a.cid=a.id||a.cid||e.index(a),a.cid;if(a instanceof Graph.Edge)return a.entity.cid+a.rel+a.type;throw new Error("Graph.Collection can only store instances of Graph.Entity and Graph.Edge.")},g={is:function(a,b){return a===b},gt:function(a,b){return a>b},lt:function(a,b){return b>a},gte:function(a,b){return a>=b},lte:function(a,b){return b>=a},regex:function(a,b){return a.search(b)>=0}},h=function(a){return a in c};this.add=function(a,b){if(f(a),!h(a.cid))return c[f(a)]=d.length,d.push(a),a;if(b){var e=d[c[a.cid]];return e.edit(a instanceof Graph.Entity?a.entity():a),e}return!1},this.remove=function(a){return h(a)?(d.splice(c[a],1),delete c[a],!0):!1},this.spawn=function(){return new Graph.Collection(a,d.slice())};var i=function(a,b){return b.length>1?i(a[b[0]],b.slice(1)):a.hasOwnProperty(b[0])?a[b[0]]:"nokey"};this.filter=function(b,c){c=!!c;for(var e,f=Object.keys(b),h=d.slice(),j=[],k=0,l=f.length;l>k;k++){e=f[k].split("__"),e.length<2&&e.push("is");var m=e.pop();j.push({key:e,op:m,value:b[f[k]]})}for(l=j.length,k=0;l>k;k++)for(var n=0;n<h.length;n++)e=j[k],("nokey"===i(h[n],e.key)||i(h[n],e.key)&&g[e.op](i(h[n],e.key),e.value)===c)&&h.splice(n--,1);return new Graph.Collection(a,h)},this.sort=function(a,b){function c(a,c){var d=b?-1:1,f=i(a,e),g=i(c,e);return g>f?-1*d:f>g?1*d:0}var e=a.split("__");return d.sort(c),this};var j=-1;if(this.first=function(){return j=-1,d[++j]},this.next=function(){if(!this.hasNext())throw new Error("Read past end of Collection.");return d[++j]},this.last=function(){return j=d.length,d[--j]},this.hasNext=function(){return j<d.length-1},b)for(var k=0,l=b.length;l>k;k++)this.add(b[k])},Graph.Entity=function(a,b){if(!(b instanceof Graph.Database))throw new Error("Must supply valid instance of Graph.Database");var c={};for(var d in a)a.hasOwnProperty(d)&&"function"!=typeof a[d]&&(this[d]=a[d]);this.db=function(){return b},this.on=function(a,b){c[a]=b},this.off=function(a){delete c[a]};var e=new Graph.Collection(this);this.entity=function(){var a={};for(var b in this)this.hasOwnProperty(b)&&"function"!=typeof this[b]&&(a[b]=this[b]);return a},this.edit=function(a){var b=[];for(var d in a)a.hasOwnProperty(d)&&(b.push({property:d,newValue:a[d],oldValue:this[d]}),this[d]=a[d]);return c.change&&c.change.call(this,"change",b),this},this.save=function(){b.update(this.cid,this.entity())},this["delete"]=function(){b.remove(this.cid)},this.edges=function(){return e},this.link=function(a){var b=new Graph.Edge(a);e.add(b),c.addedge&&c.addedge.call(this,"addedge",{entity:this,edge:b})};var f=function(a,b){b=b||[],b.push(a.cid);for(var c=[],d=0,f=0,g=e.length;g>f;f++){var h=0===f?e.first():e.next();b.indexOf(h.entity.cid)<0&&(c.push({name:h.entity.name,rel:h.rel,type:h.type,cid:h.entity.cid,edges:[]}),c[d].edges=h.entity.graph({method:"DFS",read:b}),d++)}return c},g=function(a){function b(a){for(var b=0,c=d.length;c>b;b++)if(d[b].entity===a)return!0;return!1}for(var c=[],d=[{entity:a,edges:c}],e=[];d.length>0;){var f=d.shift();e.push(f.entity);for(var g=0,h=f.entity.edges().length;h>g;g++){var i=0===g?f.entity.edges().first():f.entity.edges().next(),j=[];b(i.entity)||-1!==e.indexOf(i.entity)||(f.edges.push({name:i.entity.name,rel:i.rel,type:i.type,cid:i.entity.cid,edges:j}),d.push({entity:i.entity,edges:j}))}}return c};this.graph=function(a){var b=a.method,c=a.read;switch(b){case"DFS":return f(this,c);case"BFS":return g(this);default:throw new Error("Graph method "+b+" not supported.")}}},Graph.Database=function(a){var b=a&&a.datasource?a.datasource:{entities:[],edges:[]},c=a&&a.index?a.index:"id";this.index=function(a){if("function"==typeof c)return a.cid=c(a),a.cid;if("string"==typeof c)return a.cid=a[c],a.cid;throw new Error("Unable to index the supplied Object.")};var d=new Graph.Collection(this);this.add=function(a){return d.add(new Graph.Entity(a,this))},this.query=function(a){return a?d.spawn().filter(a):d.spawn()},this.update=function(a,b){var c=d.filter({cid:a}).first();c.edit(b)},this.remove=function(a){d.remove(a)},this.link=function(a,b,c){var e=d.filter({cid:a}).first(),f=d.filter({cid:b}).first();if(!e||!f)throw new Error(a);e.link({entity:f,rel:c,type:"out"}),f.link({entity:e,rel:c,type:"in"})},this.ingest=function(a){for(var b=0;b<a.entities.length;b++)d.add(new Graph.Entity(a.entities[b],this));for(b=0;b<a.edges.length;b++)this.link(a.edges[b].source,a.edges[b].target,a.edges[b].rel)},this.ingest(b),this.on=function(a,b,c){if(c)d.filter({cid:c}).first().on(a,b);else for(var e=0,f=d.length;f>e;e++)0===e?d.first().on(a,b):d.next().on(a,b)},this.off=function(a,b){if(b)d.filter({cid:b}).first().off(a);else for(var c=0,e=d.length;e>c;c++)0===c?d.first().off(a):d.next().off(a)}},Graph.Dashboard=function(a){if(!a)throw new Error("No options supplied.");if(!a.container)throw new Error("No options.container supplied.");if(!a.database)throw new Error("No options.database supplied.");var b=a.container;b.addClass("graph_dashboard");var c=a.database,d={};d["default"]={},d["default"].filterData={},d["default"].layout=a&&a.layout?a.layout:{rows:[{cssClass:"",cols:[{cssClass:"",component:Graph.Component.extend({})}]}]};var e=[],f={off:function(){}},g=[],h=function(a){e.push(a);for(var b in a.events)-1===g.indexOf(b)&&g.push(b.replace(/^(on)/m,""));a.dashboard=this},i=function(a){for(var c=d[a].layout,e=0,f=c.rows.length;f>e;e++)for(var g=$('<div class="'+c.rows[e]["class"]+'" />').appendTo(b),i=0,j=c.rows[e].cols.length;j>i;i++)$('<div class="'+c.rows[e].cols[i]["class"]+'" id="'+c.rows[e].cols[i].component.name+'" />').appendTo(g),h(c.rows[e].cols[i].component)};this.addLayout=function(a,b,c){d[a]={filterData:b,layout:c}},this.bind=function(a){if(!a instanceof Graph.Entity)throw new TypeError("Graph.Dashboard can only be bound to objects of type Graph.Entity");for(var c=0,h=g.length;h>c;c++)f.off(g[c]),a.on(g[c],this.update);f=a,b.html(""),e=[];var j="default";for(var k in d){var l=!1,m=Object.keys(d[k].filterData);for(h=m.length,c=0;h>c;c++){if(d[k].filterData[m[c]]!==a[m[c]]){l=!1;break}l=!0}if(l){j=k;break}}for(i(j),c=0;c<e.length;c++)e[c].render&&$("#"+e[c].name).html(e[c].render(f))},this.bindFirst=function(a){this.bind(c.query().filter(a).first())},this.update=function(a,b){for(var c=0;c<e.length;c++)e[c].events["on"+a]&&e[c].events["on"+a].call(e[c],b)},i("default")},Graph.Component={name:"base",render:function(a){var b=$('<div class="graph_component" id="graph_component_'+this.name+'"/>');for(var c in a.entity())a.hasOwnProperty(c)&&"function"!=typeof a[c]&&b.append(c+': <span class="graph_component_'+this.name+'" id="graph_component_'+this.name+"_"+c+'">'+a[c]+" </span><br/>");return b},events:{onchange:function(a){for(var b=0,c=a.length;c>b;b++)$("span#graph_component_"+this.name+"_"+a[b].property).text(a[b].newValue)}},extend:function(a){var b=Object.create(this);for(var c in this)b[c]=a[c]||this[c];for(c in a)b[c]||(b[c]=a[c]);return b}};